---
- name: Configure swapfile if not already active
  block:
    - name: Ensure btrfs subvolume exists
      become: true
      command: "btrfs subvolume create /var/swap"
      args:
        creates: /var/swap

    - name: Create swapfile via btrfs mkswapfile
      become: true
      command: "btrfs filesystem mkswapfile --size {{ (ansible_memtotal_mb // 1024) + 8 }}G --uuid clear /var/swap/swapfile"
      args:
        creates: /var/swap/swapfile

    - name: Get UUID of the filesystem containing the swapfile
      command: findmnt -no UUID -T /var/swap/swapfile
      register: swap_uuid
      changed_when: false

    - name: Add swapfile entry to /etc/fstab (low priority)
      become: true
      mount:
        name: none
        src: /var/swap/swapfile
        fstype: swap
        opts: defaults,pri=0
        state: present

    - name: Determine swapfile offset (for resume)
      become: true
      command: btrfs inspect-internal map-swapfile -r /var/swap/swapfile
      register: resume_offset
      changed_when: false

    - name: Update kernel parameters for hibernation
      become: true
      command: >
        grubby --args="resume=UUID={{ swap_uuid.stdout }} resume_offset={{ resume_offset.stdout }}" --update-kernel=ALL

    - name: Add SELinux context rule for swapfile
      become: true
      shell: |
        semanage fcontext -a -t swapfile_t '/var/swap(/.*)?' || true
        restorecon -RF /var/swap

    - name: Ensure SELinux policy directory exists
      become: true
      file:
        path: /usr/local/share/selinux/custom
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Copy systemd_hibernate .te file
      become: true
      copy:
        src: files/systemd_hibernate.te
        dest: /usr/local/share/selinux/custom/systemd_hibernate.te
        mode: '0644'

    - name: Compile systemd_hibernate
      become: true
      command: >
        checkmodule -M -m
        -o /usr/local/share/selinux/custom/systemd_hibernate.mod
        /usr/local/share/selinux/custom/systemd_hibernate.te
      args:
        creates: /usr/local/share/selinux/custom/systemd_hibernate.mod

    - name: Package systemd_hibernate
      become: true
      command: >
        semodule_package
        -o /usr/local/share/selinux/custom/systemd_hibernate.pp
        -m /usr/local/share/selinux/custom/systemd_hibernate.mod
      args:
        creates: /usr/local/share/selinux/custom/systemd_hibernate.pp

    - name: Load SELinux policy systemd_hibernate
      become: true
      command: semodule -i /usr/local/share/selinux/custom/systemd_hibernate.pp

    - name: Ensure dracut resume config exists
      become: true
      copy:
        dest: /etc/dracut.conf.d/resume.conf
        content: |
          add_dracutmodules+=" resume "
        owner: root
        group: root
        mode: '0644'

    - name: Rebuild initramfs via dracut
      become: true
      command: dracut -f

    - name: Ensure swapfile is active
      become: true
      command: swapon /var/swap/swapfile
      register: swapon_out
      failed_when: swapon_out.rc != 0 and 'already in use' not in swapon_out.stderr
      changed_when: "'already in use' not in swapon_out.stderr"

  when: "'/var/swap/swapfile' not in lookup('pipe','swapon --show=NAME')"
